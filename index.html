<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fighting Game</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
            background-color: #222;
            color: white;
        }

        #game-container {
            position: relative;
            width: 800px;
            height: 400px;
            margin: 20px auto;
            background-color: #333;
            border: 2px solid #555;
            overflow: hidden;
        }

        .player {
            position: absolute;
            width: 50px;
            height: 100px;
            bottom: 0;
            transition: transform 0.1s;
        }

        #player1 {
            left: 200px;
            background-color: #4a8;
        }

        #player2 {
            left: 600px;
            background-color: #48a;
        }

        .health-bar-container {
            position: absolute;
            top: 10px;
            width: 200px;
            height: 20px;
            background-color: #333;
            border: 2px solid #555;
        }

        #player1-health-container {
            left: 10px;
        }

        #player2-health-container {
            right: 10px;
        }

        .health-bar {
            height: 100%;
            width: 100%;
            background-color: #4a8;
            transition: width 0.3s;
        }

        #player2-health {
            background-color: #48a;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            width: 800px;
            margin: 20px auto;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        button {
            padding: 10px 15px;
            background-color: #555;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }

        button:hover {
            background-color: #666;
        }

        button:active {
            background-color: #777;
        }

        #game-status {
            text-align: center;
            margin: 10px 0;
            font-size: 24px;
            font-weight: bold;
            height: 30px;
        }

        #restart-container {
            text-align: center;
            margin: 10px 0;
            display: none;
        }

        /* Player state styles */
        .hitting {
            background-color: #a44 !important;
        }

        .kicking {
            background-color: #a84 !important;
        }

        .hurt {
            background-color: #a44 !important;
            animation: shake 0.2s ease-in-out;
        }

        .blocking {
            border: 3px solid #aa4 !important;
        }

        /* NEW: Invulnerability effect */
        .invulnerable {
            animation: flash 0.5s infinite alternate;
            opacity: 0.7;
            border: 3px dashed #4af !important;
        }

        @keyframes flash {
            from { opacity: 0.7; }
            to { opacity: 0.3; }
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        /* NEW: Combo counter */
        .combo-counter {
            position: absolute;
            color: #f44;
            font-weight: bold;
            font-size: 24px;
            text-shadow: 2px 2px 3px black;
            z-index: 100;
            display: none;
            pointer-events: none;
        }

        /* NEW: Cooldown indicator */
        .cooldown-indicator {
            position: absolute;
            bottom: -20px;
            left: 0;
            width: 100%;
            height: 5px;
            background-color: #f44;
            transform-origin: left;
            transform: scaleX(0);
        }

        /* NEW: Status effects */
        .status-effect {
            position: absolute;
            top: -25px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px black;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div class="health-bar-container" id="player1-health-container">
            <div class="health-bar" id="player1-health"></div>
        </div>
        
        <div class="health-bar-container" id="player2-health-container">
            <div class="health-bar" id="player2-health"></div>
        </div>
        
        <div id="player1" class="player">
            <div class="cooldown-indicator" id="player1-cooldown"></div>
            <div class="status-effect" id="player1-status"></div>
        </div>
        
        <div id="player2" class="player">
            <div class="cooldown-indicator" id="player2-cooldown"></div>
            <div class="status-effect" id="player2-status"></div>
        </div>
    </div>
    
    <div id="game-status">Waiting for players...</div>
    
    <div id="restart-container">
        <button id="ready-button">Ready</button>
    </div>
    
    <div class="controls">
        <div class="control-group" id="player1-controls">
            <h3>Player 1 Controls</h3>
            <div>
                <button id="p1-left">Left (A)</button>
                <button id="p1-right">Right (D)</button>
                <button id="p1-hit">Hit (W)</button>
                <button id="p1-kick">Kick (S)</button>
                <button id="p1-block">Block (Q)</button>
            </div>
        </div>
        
        <div class="control-group" id="player2-controls">
            <h3>Player 2 Controls</h3>
            <div>
                <button id="p2-left">Left (←)</button>
                <button id="p2-right">Right (→)</button>
                <button id="p2-hit">Hit (↑)</button>
                <button id="p2-kick">Kick (↓)</button>
                <button id="p2-block">Block (Enter)</button>
            </div>
        </div>
    </div>

    <!-- Combo counter elements -->
    <div id="player1-combo" class="combo-counter"></div>
    <div id="player2-combo" class="combo-counter"></div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // Game constants
        const ATTACK_COOLDOWN = 500; // ms
        const ATTACK_DURATION = 300; // ms
        const HURT_DURATION = 500; // ms
        const HIT_RANGE = 40;
        const KICK_RANGE = 50;
        const HIT_DAMAGE = 10;
        const KICK_DAMAGE = 15;
        const CRITICAL_HIT_MULTIPLIER = 1.5;
        const BLOCK_DURATION = 1000; // 1 second block duration
        const BLOCK_COOLDOWN = 2000; // 2 second cooldown between blocks
        const INVULNERABILITY_DURATION = 1500; // 1.5 seconds of invulnerability after being hit

        // Game elements
        const player1Element = document.getElementById('player1');
        const player2Element = document.getElementById('player2');
        const player1Health = document.getElementById('player1-health');
        const player2Health = document.getElementById('player2-health');
        const gameStatus = document.getElementById('game-status');
        const restartContainer = document.getElementById('restart-container');
        const readyButton = document.getElementById('ready-button');
        const player1Cooldown = document.getElementById('player1-cooldown');
        const player2Cooldown = document.getElementById('player2-cooldown');
        const player1Status = document.getElementById('player1-status');
        const player2Status = document.getElementById('player2-status');
        const player1Combo = document.getElementById('player1-combo');
        const player2Combo = document.getElementById('player2-combo');

        // Game state
        let playerId = null;
        let gameState = null;
        let keysPressed = {};
        let lastAttackTime = 0;
        let lastBlockTime = 0;
        let blockCooldown = false;

        // Connect to server
        // Replace this URL with your actual Glitch server URL
        const serverUrl = "https://https://stickmanfightingnew.glitch.me";
        const socket = io(serverUrl);

        // Receive player ID
        socket.on('playerId', (id) => {
            playerId = id;
            console.log('You are ' + playerId);
            
            if (playerId === 'observer') {
                gameStatus.textContent = 'You are an observer';
            } else {
                gameStatus.textContent = 'Waiting for opponent...';
            }
        });

        // Receive game state
        socket.on('gameState', (state) => {
            gameState = state;
            updateGameDisplay();
        });

        // Handle hit results
        socket.on('hitResult', (data) => {
            console.log('Hit result:', data);
            
            // Show hit effect
            const targetElement = data.targetId === 'player1' ? player1Element : player2Element;
            
            if (data.invulnerable) {
                // Show invulnerability effect
                targetElement.classList.add('invulnerable');
                
                // Update status text
                const statusElement = data.targetId === 'player1' ? player1Status : player2Status;
                statusElement.textContent = 'INVULNERABLE';
                statusElement.style.color = '#4af';
                
                // Clear after duration
                setTimeout(() => {
                    targetElement.classList.remove('invulnerable');
                    statusElement.textContent = '';
                }, INVULNERABILITY_DURATION);
            }
            
            // Show combo counter if it's more than 1
            if (data.comboCount && data.comboCount > 1) {
                const comboElement = data.attackerId === 'player1' ? player1Combo : player2Combo;
                const playerElement = data.attackerId === 'player1' ? player1Element : player2Element;
                
                // Position combo counter above player
                const rect = playerElement.getBoundingClientRect();
                const containerRect = document.getElementById('game-container').getBoundingClientRect();
                
                comboElement.style.left = (rect.left - containerRect.left + rect.width / 2 - 40) + 'px';
                comboElement.style.top = (rect.top - containerRect.top - 40) + 'px';
                comboElement.textContent = data.comboCount + 'x COMBO!';
                comboElement.style.display = 'block';
                
                // Hide after a moment
                setTimeout(() => {
                    comboElement.style.display = 'none';
                }, 1000);
            }
        });

        // Handle game restart
        socket.on('gameRestarted', () => {
            console.log('Game restarted');
            restartContainer.style.display = 'none';
        });

        // Handle player ready status
        socket.on('playerReady', (readyPlayers) => {
            console.log('Ready players:', readyPlayers);
            
            if (readyPlayers.includes(playerId)) {
                readyButton.disabled = true;
                readyButton.textContent = 'Waiting for opponent...';
            }
        });

        // Update game display based on state
        function updateGameDisplay() {
            if (!gameState) return;
            
            // Update player positions
            player1Element.style.left = gameState.players.player1.x + 'px';
            player2Element.style.left = gameState.players.player2.x + 'px';
            
            // Update health bars
            player1Health.style.width = gameState.players.player1.power + '%';
            player2Health.style.width = gameState.players.player2.power + '%';
            
            // Update player states
            updatePlayerState(player1Element, gameState.players.player1);
            updatePlayerState(player2Element, gameState.players.player2);
            
            // Update game status
            if (gameState.winner) {
                gameStatus.textContent = gameState.winner === 'player1' ? 'Player 1 Wins!' : 'Player 2 Wins!';
                restartContainer.style.display = 'block';
                readyButton.disabled = false;
                readyButton.textContent = 'Ready';
            } else if (gameState.gameStarted) {
                gameStatus.textContent = 'Fight!';
            } else {
                gameStatus.textContent = 'Waiting for players...';
            }
        }

        // Update player state classes
        function updatePlayerState(element, playerState) {
            // Clear all state classes
            element.classList.remove('hitting', 'kicking', 'hurt', 'blocking');
            
            // Add current state class
            if (playerState.state === 'hitting') {
                element.classList.add('hitting');
            } else if (playerState.state === 'kicking') {
                element.classList.add('kicking');
            } else if (playerState.state === 'hurt') {
                element.classList.add('hurt');
            }
            
            // Add blocking class
            if (playerState.blocking) {
                element.classList.add('blocking');
            }
            
            // Update cooldown indicator
            const cooldownElement = element.id === 'player1' ? player1Cooldown : player2Cooldown;
            const now = Date.now();
            
            if (now - playerState.lastAttackTime < ATTACK_COOLDOWN) {
                const progress = 1 - ((now - playerState.lastAttackTime) / ATTACK_COOLDOWN);
                cooldownElement.style.transform = `scaleX(${progress})`;
            } else {
                cooldownElement.style.transform = 'scaleX(0)';
            }
            
            // Update status text
            const statusElement = element.id === 'player1' ? player1Status : player2Status;
            
            if (playerState.blocking) {
                statusElement.textContent = 'BLOCKING';
                statusElement.style.color = '#aa4';
            } else if (playerState.blockCooldown) {
                statusElement.textContent = 'BLOCK CD';
                statusElement.style.color = '#a84';
            } else if (playerState.isInvulnerable) {
                statusElement.textContent = 'INVULNERABLE';
                statusElement.style.color = '#4af';
            } else {
                statusElement.textContent = '';
            }
        }

        // Check if players are close enough for a hit
        function checkHitRange(attackerId, targetId, attackType) {
            if (!gameState) return false;
            
            const attacker = gameState.players[attackerId];
            const target = gameState.players[targetId];
            
            const range = attackType === 'hit' ? HIT_RANGE : KICK_RANGE;
            const distance = Math.abs(attacker.x - target.x);
            
            return distance <= range;
        }

        // Register a hit
        function registerHit(attackerId, targetId, attackType) {
            if (!checkHitRange(attackerId, targetId, attackType)) return;
            
            const damage = attackType === 'hit' ? HIT_DAMAGE : KICK_DAMAGE;
            
            // Check for critical hit (back attack)
            let criticalHit = false;
            const attacker = gameState.players[attackerId];
            const target = gameState.players[targetId];
            
            if ((attackerId === 'player1' && attacker.x < target.x) || 
                (attackerId === 'player2' && attacker.x > target.x)) {
                criticalHit = true;
            }
            
            const finalDamage = criticalHit ? Math.floor(damage * CRITICAL_HIT_MULTIPLIER) : damage;
            
            // Send hit registration to server
            socket.emit('registerHit', {
                attackerId: attackerId,
                targetId: targetId,
                damage: finalDamage,
                hitZone: attackType
            });
        }

        // Handle keyboard input
        document.addEventListener('keydown', (e) => {
            if (!playerId || playerId === 'observer') return;
            
            keysPressed[e.key] = true;
            
            // Player 1 controls
            if (playerId === 'player1') {
                if (e.key === 'a' || e.key === 'A') {
                    socket.emit('move', { direction: 'left' });
                } else if (e.key === 'd' || e.key === 'D') {
                    socket.emit('move', { direction: 'right' });
                } else if (e.key === 'w' || e.key === 'W') {
                    const now = Date.now();
                    if (now - lastAttackTime >= ATTACK_COOLDOWN) {
                        socket.emit('attack', { type: 'hit' });
                        lastAttackTime = now;
                        
                        // Register hit after a short delay to match animation
                        setTimeout(() => {
                            registerHit('player1', 'player2', 'hit');
                        }, 100);
                    }
                } else if (e.key === 's' || e.key === 'S') {
                    const now = Date.now();
                    if (now - lastAttackTime >= ATTACK_COOLDOWN) {
                        socket.emit('attack', { type: 'kick' });
                        lastAttackTime = now;
                        
                        // Register hit after a short delay to match animation
                        setTimeout(() => {
                            registerHit('player1', 'player2', 'kick');
                        }, 100);
                    }
                } else if (e.key === 'q' || e.key === 'Q') {
                    const now = Date.now();
                    if (!blockCooldown && now - lastBlockTime >= BLOCK_COOLDOWN) {
                        socket.emit('block', { blocking: true });
                    }
                }
            }
            
            // Player 2 controls
            if (playerId === 'player2') {
                if (e.key === 'ArrowLeft') {
                    socket.emit('move', { direction: 'left' });
                } else if (e.key === 'ArrowRight') {
                    socket.emit('move', { direction: 'right' });
                } else if (e.key === 'ArrowUp') {
                    const now = Date.now();
                    if (now - lastAttackTime >= ATTACK_COOLDOWN) {
                        socket.emit('attack', { type: 'hit' });
                        lastAttackTime = now;
                        
                        // Register hit after a short delay to match animation
                        setTimeout(() => {
                            registerHit('player2', 'player1', 'hit');
                        }, 100);
                    }
                } else if (e.key === 'ArrowDown') {
                    const now = Date.now();
                    if (now - lastAttackTime >= ATTACK_COOLDOWN) {
                        socket.emit('attack', { type: 'kick' });
                        lastAttackTime = now;
                        
                        // Register hit after a short delay to match animation
                        setTimeout(() => {
                            registerHit('player2', 'player1', 'kick');
                        }, 100);
                    }
                } else if (e.key === 'Enter') {
                    const now = Date.now();
                    if (!blockCooldown && now - lastBlockTime >= BLOCK_COOLDOWN) {
                        socket.emit('block', { blocking: true });
                    }
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            if (!playerId || playerId === 'observer') return;
            
            keysPressed[e.key] = false;
            
            // Player 1 controls
            if (playerId === 'player1') {
                if ((e.key === 'a' || e.key === 'A') && !keysPressed['d'] && !keysPressed['D']) {
                    socket.emit('stopMove');
                } else if ((e.key === 'd' || e.key === 'D') && !keysPressed['a'] && !keysPressed['A']) {
                    socket.emit('stopMove');
                } else if (e.key === 'q' || e.key === 'Q') {
                    socket.emit('block', { blocking: false });
                    lastBlockTime = Date.now();
                    blockCooldown = true;
                    
                    // Reset block cooldown
                    setTimeout(() => {
                        blockCooldown = false;
                    }, BLOCK_COOLDOWN);
                }
            }
            
            // Player 2 controls
            if (playerId === 'player2') {
                if (e.key === 'ArrowLeft' && !keysPressed['ArrowRight']) {
                    socket.emit('stopMove');
                } else if (e.key === 'ArrowRight' && !keysPressed['ArrowLeft']) {
                    socket.emit('stopMove');
                } else if (e.key === 'Enter') {
                    socket.emit('block', { blocking: false });
                    lastBlockTime = Date.now();
                    blockCooldown = true;
                    
                    // Reset block cooldown
                    setTimeout(() => {
                        blockCooldown = false;
                    }, BLOCK_COOLDOWN);
                }
            }
        });

        // Button controls
        document.getElementById('p1-left').addEventListener('mousedown', () => {
            if (playerId === 'player1') {
                socket.emit('move', { direction: 'left' });
            }
        });
        
        document.getElementById('p1-right').addEventListener('mousedown', () => {
            if (playerId === 'player1') {
                socket.emit('move', { direction: 'right' });
            }
        });
        
        document.getElementById('p1-hit').addEventListener('click', () => {
            if (playerId === 'player1') {
                const now = Date.now();
                if (now - lastAttackTime >= ATTACK_COOLDOWN) {
                    socket.emit('attack', { type: 'hit' });
                    lastAttackTime = now;
                    
                    setTimeout(() => {
                        registerHit('player1', 'player2', 'hit');
                    }, 100);
                }
            }
        });
        
        document.getElementById('p1-kick').addEventListener('click', () => {
            if (playerId === 'player1') {
                const now = Date.now();
                if (now - lastAttackTime >= ATTACK_COOLDOWN) {
                    socket.emit('attack', { type: 'kick' });
                    lastAttackTime = now;
                    
                    setTimeout(() => {
                        registerHit('player1', 'player2', 'kick');
                    }, 100);
                }
            }
        });
        
        document.getElementById('p1-block').addEventListener('mousedown', () => {
            if (playerId === 'player1') {
                const now = Date.now();
                if (!blockCooldown && now - lastBlockTime >= BLOCK_COOLDOWN) {
                    socket.emit('block', { blocking: true });
                }
            }
        });
        
        document.getElementById('p1-block').addEventListener('mouseup', () => {
            if (playerId === 'player1') {
                socket.emit('block', { blocking: false });
                lastBlockTime = Date.now();
                blockCooldown = true;
                
                setTimeout(() => {
                    blockCooldown = false;
                }, BLOCK_COOLDOWN);
            }
        });
        
        document.getElementById('p2-left').addEventListener('mousedown', () => {
            if (playerId === 'player2') {
                socket.emit('move', { direction: 'left' });
            }
        });
        
        document.getElementById('p2-right').addEventListener('mousedown', () => {
            if (playerId === 'player2') {
                socket.emit('move', { direction: 'right' });
            }
        });
        
        document.getElementById('p2-hit').addEventListener('click', () => {
            if (playerId === 'player2') {
                const now = Date.now();
                if (now - lastAttackTime >= ATTACK_COOLDOWN) {
                    socket.emit('attack', { type: 'hit' });
                    lastAttackTime = now;
                    
                    setTimeout(() => {
                        registerHit('player2', 'player1', 'hit');
                    }, 100);
                }
            }
        });
        
        document.getElementById('p2-kick').addEventListener('click', () => {
            if (playerId === 'player2') {
                const now = Date.now();
                if (now - lastAttackTime >= ATTACK_COOLDOWN) {
                    socket.emit('attack', { type: 'kick' });
                    lastAttackTime = now;
                    
                    setTimeout(() => {
                        registerHit('player2', 'player1', 'kick');
                    }, 100);
                }
            }
        });
        
        document.getElementById('p2-block').addEventListener('mousedown', () => {
            if (playerId === 'player2') {
                const now = Date.now();
                if (!blockCooldown && now - lastBlockTime >= BLOCK_COOLDOWN) {
                    socket.emit('block', { blocking: true });
                }
            }
        });
        
        document.getElementById('p2-block').addEventListener('mouseup', () => {
            if (playerId === 'player2') {
                socket.emit('block', { blocking: false });
                lastBlockTime = Date.now();
                blockCooldown = true;
                
                setTimeout(() => {
                    blockCooldown = false;
                }, BLOCK_COOLDOWN);
            }
        });
        
        // Stop movement when mouse is released
        document.getElementById('p1-left').addEventListener('mouseup', () => {
            if (playerId === 'player1') {
                socket.emit('stopMove');
            }
        });
        
        document.getElementById('p1-right').addEventListener('mouseup', () => {
            if (playerId === 'player1') {
                socket.emit('stopMove');
            }
        });
        
        document.getElementById('p2-left').addEventListener('mouseup', () => {
            if (playerId === 'player2') {
                socket.emit('stopMove');
            }
        });
        
        document.getElementById('p2-right').addEventListener('mouseup', () => {
            if (playerId === 'player2') {
                socket.emit('stopMove');
            }
        });
        
        // Ready button
        readyButton.addEventListener('click', () => {
            if (playerId) {
                socket.emit('playerReady', playerId);
                readyButton.disabled = true;
                readyButton.textContent = 'Waiting for opponent...';
            }
        });
    </script>
</body>
</html>
