<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stickman Fighting Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            overflow: hidden; /* Prevent scrollbars */
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #gameContainer {
            position: relative;
            width: 800px;
            height: 600px;
            background-color: #fff;
            border: 2px solid #000;
            overflow: hidden;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #eee;
        }

        #waitingMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #888;
        }

        #winnerMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            color: green;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            display: none; /* Hidden by default */
        }

        #restartBtn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            font-size: 18px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #restartBtn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .status-indicator {
            position: absolute;
            top: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            color: white;
        }

        .status-waiting {
            background-color: #aaa;
        }

        .status-ready {
            background-color: #4CAF50;
        }

        #player1Status {
            left: 10px;
        }

        #player2Status {
            right: 10px;
        }

        /* Debug console */
        #debugConsole {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px;
            font-size: 12px;
            overflow-y: scroll;
            max-height: 100px;
            z-index: 1000;
        }

        /* Sound control button */
        #soundToggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 5px;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
        }

    /* Sound control styles */
    #soundControl {
        position: fixed;
        top: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 5px;
        border-radius: 5px;
        z-index: 30;
        cursor: pointer;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }
    </style>
</head>
<body>
    <div id="gameContainer">
        <button id="soundToggle">ðŸ”Š</button>
        <canvas id="gameCanvas"></canvas>
        <div id="waitingMessage">Waiting for another player...</div>
        <div id="winnerMessage"></div>
        <button id="restartBtn">Play Again</button>
        <div id="player1Status" class="status-indicator status-waiting">Player 1: Waiting</div>
        <div id="player2Status" class="status-indicator status-waiting">Player 2: Waiting</div>
        <div id="soundControl">ðŸ”Š</div>
    </div>
    <div id="debugConsole"></div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js" integrity="sha384-mZLF4UVrpi/QTWPA7BjNPEnkIfRFn4ZEO3Qt/HFklTJBj/gBOV8G3HcKn4NfQblz" crossorigin="anonymous"></script>
    <script>
        const canvasWidth = 800;
        const canvasHeight = 600;
        let canvas, ctx;
        let socket;
        let playerId;
        let players = {};
        let gameStarted = false;
        let readyPlayers = [];
        const GLITCH_SERVER_URL = "https://stickmanfightingnew.glitch.me";
    // Sound variables
    let soundEnabled = true;
    let sounds = {};
    let soundsLoaded = false;

        // Sound system
        let sounds = {};
        let soundsLoaded = 0;
        let totalSounds = 0;
        let soundsEnabled = true;

        // Sound file paths - replace these with your custom audio paths
        const SOUND_PATHS = {
            hit: '/assets/hit.mp3',
            kick: '/assets/kick.mp3',
            hurt: '/sounds/hurt.mp3',
            victory: '/sounds/victory.mp3',
            gameStart: '/sounds/game-start.mp3',
            button: '/sounds/button-click.mp3'
        };

        let prevGameStarted = false;

        function debug(message) {
            const debugConsole = document.getElementById('debugConsole');
            debugConsole.textContent += message + '\n';
            debugConsole.scrollTop = debugConsole.scrollHeight; // Auto-scroll to bottom
        }

        // Load all sounds
        function loadSounds() {
            totalSounds = Object.keys(SOUND_PATHS).length;
            soundsLoaded = 0;
            
            for (const [name, path] of Object.entries(SOUND_PATHS)) {
                loadSound(name, path);
            }
            
            // Initialize audio system on mobile devices (requires user interaction)
            document.addEventListener('touchstart', initAudioForMobile, { once: true });
        }

        // Load individual sound
        function loadSound(name, path) {
            try {
                const audio = new Audio();
                audio.volume = 0.5; // 50% volume by default
                
                // When sound is loaded
                audio.addEventListener('canplaythrough', function onCanPlay() {
                    soundsLoaded++;
                    audio.removeEventListener('canplaythrough', onCanPlay);
                    debug(`Loaded sound: ${name}, ${soundsLoaded}/${totalSounds}`);
                    
                    // Initialize first sound after at least one is loaded
                    if (soundsLoaded === 1) {
                        initializeFirstSound();
                    }
                });
                
                // Error handling
                audio.addEventListener('error', function(e) {
                    console.error(`Error loading sound ${name} from ${path}:`, e);
                    // Still count this sound as "loaded" to prevent hanging
                    soundsLoaded++;
                });
                
                audio.src = path;
                audio.load();
                sounds[name] = audio;
            } catch (e) {
                console.error(`Could not create audio for ${name}:`, e);
                soundsLoaded++;
            }
        }

        // Initialize first sound (helps with mobile audio)
        function initializeFirstSound() {
            debug('Initializing first sound');
            try {
                // Try to play and immediately pause first sound to initialize audio system
                const firstSound = Object.values(sounds)[0];
                if (firstSound) {
                    firstSound.play().then(() => {
                        firstSound.pause();
                        firstSound.currentTime = 0;
                    }).catch(e => {
                        console.warn('Could not auto-initialize sound (this is normal on mobile):', e);
                    });
                }
            } catch (e) {
                console.warn('Error initializing first sound:', e);
            }
        }

        // Initialize audio on mobile (called on first touch)
        function initAudioForMobile() {
            debug('Initializing audio for mobile');
            try {
                // Try to play and immediately pause a sound to unlock audio on iOS
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Create and play a silent buffer
                const buffer = audioContext.createBuffer(1, 1, 22050);
                const source = audioContext.createBufferSource();
                source.buffer = buffer;
                source.connect(audioContext.destination);
                source.start(0);
                
                // Try to play each sound briefly
                Object.values(sounds).forEach(sound => {
                    try {
                        sound.play().then(() => {
                            sound.pause();
                            sound.currentTime = 0;
                        }).catch(e => {
                            console.warn('Could not initialize sound on mobile:', e);
                        });
                    } catch (e) { 
                        console.warn('Error with sound on mobile:', e);
                    }
                });
            } catch (e) {
                console.warn('Could not initialize AudioContext:', e);
            }
        }

        // Play a sound with optional volume
        function playSound(name, volume = 0.5) {
            if (!soundsEnabled) return;
            
            try {
                const sound = sounds[name];
                if (!sound) {
                    console.warn(`Sound '${name}' not found`);
                    return;
                }
                
                // Clone the audio to allow overlapping sounds
                const soundClone = sound.cloneNode();
                soundClone.volume = volume;
                
                soundClone.play().catch(e => {
                    console.warn(`Could not play sound '${name}':`, e);
                });
            } catch (e) {
                console.warn(`Error playing sound '${name}':`, e);
            }
        }

        // Toggle sound on/off
        function toggleSound() {
            soundsEnabled = !soundsEnabled;
            const soundToggle = document.getElementById('soundToggle');
            
            if (soundToggle) {
                soundToggle.textContent = soundsEnabled ? 'ðŸ”Š' : 'ðŸ”‡';
            }
            
            // Play a sound if we just enabled sounds
            if (soundsEnabled) {
                playSound('button');
            }
            
            debug(`Sounds ${soundsEnabled ? 'enabled' : 'disabled'}`);
        }

        function connectToServer() {
            socket = io(GLITCH_SERVER_URL, { transports: ['websocket'] });

            socket.on('connect', () => {
                playerId = socket.id;
                debug("Connected to server with ID: " + playerId);
            });

            socket.on('gameState', function(state) {
                // Keep track of previous player states to detect changes
                const prevPlayer1State = players.player1 ? players.player1.state : null;
                const prevPlayer2State = players.player2 ? players.player2.state : null;
                
                players = state.players;
                gameStarted = state.gameStarted;
                
                // Play sound when game starts
                if (gameStarted && !prevGameStarted) {
                    playSound('gameStart');
                    prevGameStarted = true;
                } else if (!gameStarted) {
                    prevGameStarted = false;
                }
                
                // Play sounds based on state changes
                if (players.player1 && prevPlayer1State !== players.player1.state) {
                    if (players.player1.state === 'hitting') playSound('hit');
                    if (players.player1.state === 'kicking') playSound('kick');
                    if (players.player1.state === 'hurt') playSound('hurt');
                }
                if (players.player2 && prevPlayer2State !== players.player2.state) {
                    if (players.player2.state === 'hitting') playSound('hit');
                    if (players.player2.state === 'kicking') playSound('kick');
                    if (players.player2.state === 'hurt') playSound('hurt');
                }
                
                // Show/hide waiting message
                document.getElementById('waitingMessage').style.display = 
                    gameStarted ? 'none' : 'block';
                
                // Check for winner
                if (state.winner) {
                    showWinner(state.winner);
                    playSound('victory');
                } else if (state.winner === null && document.getElementById('winnerMessage').style.display === 'block') {
                    // Game has been reset, hide winner message
                    document.getElementById('winnerMessage').style.display = 'none';
                    
                    // Reset button state
                    const restartBtn = document.getElementById('restartBtn');
                    restartBtn.textContent = 'Play Again';
                    restartBtn.disabled = false;
                    
                    // Reset player status indicators
                    document.getElementById('player1Status').className = 'status-indicator status-waiting';
                    document.getElementById('player1Status').textContent = 'Player 1: Waiting';
                    document.getElementById('player2Status').className = 'status-indicator status-waiting';
                    document.getElementById('player2Status').textContent = 'Player 2: Waiting';
                    
                    // Clear ready players array
                    readyPlayers = [];
                }
            });

            socket.on('playerJoined', (newPlayerId) => {
                debug("Player joined with ID: " + newPlayerId);
            });

            socket.on('playerDisconnected', (disconnectedPlayerId) => {
                debug("Player disconnected with ID: " + disconnectedPlayerId);
            });
        }

        function setupRestartButton() {
            const restartBtn = document.getElementById('restartBtn');
            
            // Add event handler for restart button
            restartBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Play button sound
                playSound('button');
                
                if (socket && playerId) {
                    // Send player ready status to server
                    socket.emit('playerReady', playerId);
                    
                    // Update button state
                    this.textContent = 'Waiting for other player...';
                    this.disabled = true;
                    
                    debug("Sent playerReady: " + playerId);
                }
            });
        }

        function showWinner(winner) {
            const winnerMessage = document.getElementById('winnerMessage');
            winnerMessage.textContent = winner === playerId ? 'You Win!' : 'You Lose!';
            winnerMessage.style.display = 'block';
            playSound('victory');
        }

        function resizeCanvas() {
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            draw(); // Redraw the scene after resizing
        }

    // Load all game sounds
    function loadSounds() {
        const soundFiles = {
            hit: '/sounds/hit.mp3',
            kick: '/sounds/kick.mp3',
            hurt: '/sounds/hurt.mp3',
            victory: '/sounds/victory.mp3',
            gameStart: '/sounds/game-start.mp3',
            button: '/sounds/button-click.mp3'
        };
        
        let loadedCount = 0;
        const totalSounds = Object.keys(soundFiles).length;
        
        // Create audio objects for each sound
        for (const [name, url] of Object.entries(soundFiles)) {
            sounds[name] = new Audio();
            sounds[name].src = url;
            
            // Handle loading
            sounds[name].addEventListener('canplaythrough', () => {
                loadedCount++;
                if (loadedCount === totalSounds) {
                    soundsLoaded = true;
                    console.log('All sounds loaded');
                }
            });
            
            // Handle errors
            sounds[name].addEventListener('error', (e) => {
                console.error(`Error loading sound ${name}:`, e);
            });
            
            // Preload the sound
            sounds[name].load();
        }
    }
    
    // Play a sound with error handling
    function playSound(name) {
        if (!soundEnabled || !soundsLoaded) return;
        
        try {
            // Create a clone to allow overlapping sounds
            const sound = sounds[name].cloneNode();
            sound.volume = 0.5; // Set volume to 50%
            
            // Play the sound with a promise and catch any errors
            const playPromise = sound.play();
            
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.warn(`Sound play error (${name}):`, error);
                });
            }
        } catch (error) {
            console.error(`Error playing sound ${name}:`, error);
        }
    }
    
    // Set up sound control button
    function setupSoundControl() {
        const soundControl = document.getElementById('soundControl');
        
        soundControl.addEventListener('click', function() {
            soundEnabled = !soundEnabled;
            this.textContent = soundEnabled ? 'ðŸ”Š' : 'ðŸ”‡';
            
            // Play a sound to confirm it's working
            if (soundEnabled) {
                playSound('button');
            }
        });
    }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw players
            for (let id in players) {
                let player = players[id];
                drawStickman(player);
            }
        }

        function drawStickman(player) {
            if (!player) return;

            ctx.save(); // Save the current drawing state

            // Set the color based on player ID
            ctx.fillStyle = player.id === playerId ? 'blue' : 'red';

            // Draw the stickman's body
            ctx.beginPath();
            ctx.arc(player.x, player.y, 20, 0, Math.PI * 2); // Head
            ctx.moveTo(player.x, player.y + 20);
            ctx.lineTo(player.x, player.y + 70); // Body
            ctx.moveTo(player.x, player.y + 45);
            ctx.lineTo(player.x - 25, player.y + 25); // Left arm
            ctx.moveTo(player.x, player.y + 45);
            ctx.lineTo(player.x + 25, player.y + 25); // Right arm
            ctx.moveTo(player.x, player.y + 70);
            ctx.lineTo(player.x - 25, player.y + 90); // Left leg
            ctx.moveTo(player.x, player.y + 70);
            ctx.lineTo(player.x + 25, player.y + 90); // Right leg
            ctx.stroke();
            ctx.fill();

            // Draw sword if attacking
            if (player.state === 'hitting') {
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.moveTo(player.x + 25, player.y + 25);
                ctx.lineTo(player.x + 50, player.y);
                ctx.stroke();
            }

            ctx.restore(); // Restore the drawing state
        }

        function gameLoop() {
            draw();
            requestAnimationFrame(gameLoop);
        }

        window.onload = function() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // Set canvas size
            resizeCanvas();
            
    // Load sounds
    loadSounds();
    
    // Set up sound control
    setupSoundControl();
            window.addEventListener('resize', resizeCanvas);
            
            // Initialize sound system
            loadSounds();
            
            // Set up sound toggle button
            const soundToggle = document.getElementById('soundToggle');
            if (soundToggle) {
                soundToggle.addEventListener('click', toggleSound);
            }
            
            // Connect to server automatically
            connectToServer();
            
            // Set up restart button with multiple event types
            setupRestartButton();
            
            // Start game loop
            requestAnimationFrame(gameLoop);
        };
    </script>
</body>
</html>
